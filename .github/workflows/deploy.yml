name: Deploy Frontend

# develop/master ë¸Œëœì¹˜ì— pushë˜ê±°ë‚˜ PRì´ ìƒì„±ë  ë•Œ ì‹¤í–‰
on:
  push:
    branches: [ develop, master ]  # develop(deví™˜ê²½), master(prodí™˜ê²½) ë¸Œëœì¹˜ ì§€ì›
  pull_request:
    branches: [ develop, master ]  # PR ìƒì„± ì‹œ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰

jobs:
  deploy:
    # develop ë˜ëŠ” master ë¸Œëœì¹˜ì— pushë  ë•Œë§Œ ë°°í¬ (PR ë¨¸ì§€ ì™„ë£Œ í›„)
    if: (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      AWS_REGION: ap-northeast-2

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate required secrets
      run: |
        missing=0
        check_secret() { if [ -z "$1" ]; then echo "::error::Missing required secret: $2"; missing=1; fi }
        # Core AWS creds
        check_secret "${{ secrets.AWS_ACCESS_KEY_ID }}" AWS_ACCESS_KEY_ID
        check_secret "${{ secrets.AWS_SECRET_ACCESS_KEY }}" AWS_SECRET_ACCESS_KEY
        # Optional session token (no fail if missing, but warn)
        if [ -z "${{ secrets.AWS_SESSION_TOKEN }}" ]; then echo "::warning::AWS_SESSION_TOKEN not set (OK if using long-lived keys)"; fi
        # Region (optional as we default to env), warn if missing
        if [ -z "${{ secrets.AWS_REGION }}" ]; then echo "::notice::AWS_REGION secret not set; using default $AWS_REGION"; fi
        # Buckets & CloudFront IDs for both envs
        check_secret "${{ secrets.S3_BUCKET_PROD }}" S3_BUCKET_PROD
        check_secret "${{ secrets.S3_BUCKET_STAGING }}" S3_BUCKET_STAGING
        check_secret "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_PROD }}" CLOUDFRONT_DISTRIBUTION_ID_PROD
        check_secret "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STAGING }}" CLOUDFRONT_DISTRIBUTION_ID_STAGING
        # Slack webhook
        check_secret "${{ secrets.SLACK_WEBHOOK_URL }}" SLACK_WEBHOOK_URL
        if [ "$missing" -eq 1 ]; then echo "::error::One or more required secrets are missing"; exit 1; fi

    - name: Extract Jira ticket from commit
      id: jira-ticket
      run: |
        echo "ğŸ” Extracting Jira ticket..."
        echo "Commit message: '${{ github.event.head_commit.message }}'"
        
        # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ FABLINK-XXX íŒ¨í„´ ì¶”ì¶œ
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        JIRA_TICKET=$(echo "$COMMIT_MSG" | grep -oE 'FABLINK-[0-9]+' | head -1)
        echo "Method 1 result: '$JIRA_TICKET'"
        
        # ë§Œì•½ ì»¤ë°‹ ë©”ì‹œì§€ì— ì—†ìœ¼ë©´ ë¨¸ì§€ ì»¤ë°‹ì—ì„œ ì¶”ì¶œ ì‹œë„
        if [ -z "$JIRA_TICKET" ]; then
          # ë¨¸ì§€ ì»¤ë°‹ ë©”ì‹œì§€ í˜•íƒœ: "Merge pull request #XX from user/FABLINK-152"
          JIRA_TICKET=$(echo "$COMMIT_MSG" | sed -n 's/.*from [^/]*\/\(FABLINK-[0-9]\+\).*/\1/p')
          echo "Method 2 result: '$JIRA_TICKET'"
        fi
        
        # ì—¬ì „íˆ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        if [ -z "$JIRA_TICKET" ]; then
          JIRA_TICKET="FABLINK-Unknown"
          echo "Fallback: '$JIRA_TICKET'"
        fi
        
        echo "JIRA_TICKET=$JIRA_TICKET" >> $GITHUB_OUTPUT
        echo "ğŸ« Final Jira ticket: $JIRA_TICKET"

    - name: Set environment variables
      run: |
        # Optional override of region from secrets
        if [ -n "${{ secrets.AWS_REGION }}" ]; then echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV; fi
        if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "ğŸ¯ Deploying to PRODUCTION environment"
          echo "S3_BUCKET=${{ secrets.S3_BUCKET_PROD }}" >> $GITHUB_ENV
          echo "CLOUDFRONT_DISTRIBUTION_ID=${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_PROD }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          echo "FRONTEND_URL=https://fab-link.org" >> $GITHUB_ENV
        else
          echo "ğŸ¯ Deploying to DEVELOPMENT environment"
          echo "S3_BUCKET=${{ secrets.S3_BUCKET_STAGING }}" >> $GITHUB_ENV
          echo "CLOUDFRONT_DISTRIBUTION_ID=${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STAGING }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          echo "FRONTEND_URL=https://dev.fab-link.org" >> $GITHUB_ENV
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --legacy-peer-deps

    - name: Build application
      run: |
        echo "ğŸ”¨ Building Frontend for ${{ env.ENVIRONMENT }} environment..."
        npm run build
        echo "âœ… Frontend build completed!"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to S3
      run: |
        echo "ğŸš€ Deploying to ${{ env.ENVIRONMENT }} environment..."
        echo "ğŸ¯ Target: ${{ env.S3_BUCKET }}"
        
        # S3ì— íŒŒì¼ ì—…ë¡œë“œ
        aws s3 sync out/ s3://${{ env.S3_BUCKET }} --delete
        echo "âœ… S3 deployment completed!"

    - name: Invalidate CloudFront
      run: |
        echo "ğŸ”„ Invalidating CloudFront cache..."
        aws cloudfront create-invalidation \
          --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
          --paths "/*"
        echo "âœ… CloudFront invalidation completed!"

    - name: Deployment Summary
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo ""
          echo "ğŸ‰ =================================="
          echo "âœ… ${{ env.ENVIRONMENT }} Frontend Deployment SUCCESS!"
          echo "=================================="
          echo "ğŸŒ Frontend URL: ${{ env.FRONTEND_URL }}"
          echo "ğŸ“¦ S3 Bucket: ${{ env.S3_BUCKET }}"
          echo "ğŸ”„ CloudFront: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo ""
          echo "ğŸ·ï¸  Git Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ¯ Environment: ${{ env.ENVIRONMENT }}"
          echo "=================================="
        else
          echo ""
          echo "âŒ =================================="
          echo "ğŸ’¥ ${{ env.ENVIRONMENT }} Frontend Deployment FAILED!"
          echo "=================================="
          echo "ğŸ” Please check the logs above for details."
          echo "ğŸ› Debug steps:"
          echo "   1. Check build logs for compilation errors"
          echo "   2. Verify AWS credentials and permissions"
          echo "   3. Check S3 bucket and CloudFront configuration"
          echo "=================================="
          exit 1
        fi

    - name: Send Slack notification
      if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ì‹¤í–‰
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#ê°œë°œ-ì•Œë¦¼'  # ìŠ¬ë™ ì±„ë„ëª… (ì‹¤ì œ ì±„ë„ëª…ìœ¼ë¡œ ë³€ê²½)
        text: |
          ğŸŒ Frontend ë°°í¬ ì•Œë¦¼
          
          ğŸ“‹ ì§€ë¼ í‹°ì¼“: <https://fablink.atlassian.net/jira/software/projects/FABLINK/boards/1/timeline?selectedIssue=${{ steps.jira-ticket.outputs.JIRA_TICKET }}|${{ steps.jira-ticket.outputs.JIRA_TICKET }}>
          ğŸ’¬ ì‘ì—…(ì»¤ë°‹) ë‚´ìš©: ${{ github.event.head_commit.message }}
          ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}
          ğŸ¯ í™˜ê²½: ${{ env.ENVIRONMENT }}
          ğŸ‘¤ ì‘ì—…ì: ${{ github.actor }}
          ğŸ“… ì‹œê°„: ${{ github.event.head_commit.timestamp }}
          
          ${{ job.status == 'success' && 'âœ… ë°°í¬ ì„±ê³µ!' || 'âŒ ë°°í¬ ì‹¤íŒ¨!' }}
          
          ${{ job.status == 'success' && format('ğŸŒ Frontend: {0}', env.FRONTEND_URL) || 'ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
